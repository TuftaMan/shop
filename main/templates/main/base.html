{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Мой Магазин{% endblock %}</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-white">

<header class="sticky top-0 bg-white shadow z-50">
    <div class="container mx-auto flex justify-between items-center p-4">
        <!-- ЛЕВАЯ ЧАСТЬ — ВЫПАДАЮЩЕЕ МЕНЮ + ЛОГОТИП -->
        <div class="flex items-center space-x-3">
            <!-- Кнопка меню -->
            <div class="relative">
                <button id="menu-button" class="flex items-center">
                    <img src="{% static 'main/three-line-horizontal.svg' %}" alt="Меню" class="h-10 cursor-pointer">
                </button>
                
                <!-- Выпадающее меню -->
                <div id="dropdown-menu" class="hidden absolute left-0 mt-2 w-40 bg-white shadow-lg border rounded-lg overflow-hidden z-50">
                    <button hx-get="{% url 'main:catalog_all' %}" 
                            hx-target="#main-content" 
                            hx-push-url="true" 
                            class="w-full text-left px-4 py-2 hover:bg-gray-100">
                        Магазин
                    </button>
                    <button hx-get="{% url 'main:about' %}" 
                            hx-target="#main-content" 
                            hx-push-url="true" 
                            class="w-full text-left px-4 py-2 hover:bg-gray-100">
                        О нас
                    </button>
                </div>
            </div>
            <!-- ЛОГОТИП (переход на главную) -->
            <a href="{% url 'main:index' %}"
                class="flex items-center">
                <img src="{% static 'main/DRIFT.png' %}" 
                    alt="DriftWood" 
                    class="h-7 cursor-pointer hover:opacity-80 transition">
            </a>
        </div>

        <!-- ПРАВАЯ ЧАСТЬ — ИКОНКА КОРЗИНЫ -->
        <div>
            <button id="cart-button" 
                    hx-get="{% url 'cart:cart_modal' %}" 
                    hx-target="#main-cart-modal" 
                    hx-swap="innerHTML"
                    class="relative">
                <img src="{% static 'main/7784863.png' %}" alt="Корзина" class="h-8">
                <span id="cart-count" class="absolute top-0 right-0 bg-red-500 text-white rounded-full text-xs w-5 h-5 flex items-center justify-center">
                    0
                </span>
            </button>
            <a href="{% url 'users:profile' %}" 
                hx-get="{% url 'users:profile' %}" 
                hx-target="#main-content" 
                hx-push-url="true"
                class="text-sm font-medium text-gray-900 uppercase hover:text-gray-600 ml-4">
                    ACCOUNT
                </a>
        </div>
    </div>
</header>


<!-- ОСНОВНОЙ КОНТЕЙНЕР HTMX -->
<main id="main-content">
    {% block main_content %}
    <!-- Главная большая картинка -->
    <a
        hx-get="{% url 'main:catalog_all' %}"
        hx-target="#main-content"
        hx-push-url="true"
    >
        <img src="{% static 'main/1.png' %}" alt="Главная" class="w-full h-screen object-cover cursor-pointer">
    </a>
    {% endblock %}
</main>


<!-- Модальное окно корзины -->
<div id="main-cart-modal" 
     class="fixed top-16 right-0 bg-white w-96 max-h-[80vh] overflow-y-auto
            shadow-2xl border border-gray-200 rounded-xl hidden z-50 transition-all duration-300">
</div>


<!-- КОНТЕЙНЕР ДЛЯ УВЕДОМЛЕНИЙ - ЭТО ВАЖНО! -->
<div id="notification-container" class="fixed bottom-4 right-4 z-[9999] flex flex-col gap-2"></div>


<footer class="bg-gray-100 py-8 mt-8">
    <div class="container mx-auto text-center text-white-700">
        <p>© 2025 Мой Магазин. Все права защищены.</p>
    </div>
</footer>


<script>
// ========== ВЫПАДАЮЩЕЕ МЕНЮ ==========
const menuButton = document.getElementById("menu-button");
const dropdownMenu = document.getElementById("dropdown-menu");

// Открытие/закрытие меню
menuButton.addEventListener("click", (e) => {
    e.stopPropagation();
    dropdownMenu.classList.toggle("hidden");
});

// Закрытие меню по клику вне его
document.addEventListener("click", (e) => {
    if (!menuButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.classList.add("hidden");
    }
});

// Закрытие меню после клика на пункт меню
const menuItems = dropdownMenu.querySelectorAll("button, a");
menuItems.forEach(item => {
    item.addEventListener("click", () => {
        dropdownMenu.classList.add("hidden");
    });
});


// ========== КОРЗИНА ==========
document.getElementById('cart-button').addEventListener('click', function() {
    const modal = document.getElementById('main-cart-modal');
    modal.classList.toggle('hidden');
});

function updateCartCount() {
    fetch("{% url 'cart:cart_count' %}")
        .then(res => res.json())
        .then(data => {
            document.getElementById('cart-count').textContent = data.total_items;
        })
        .catch(err => console.error('Error updating cart count:', err));
}

function updateCartSummary() {
    // Обновляем блок итогов после изменений в корзине
    const summaryEl = document.getElementById('cart-summary');
    if (!summaryEl) return; // Если элемента нет (корзина закрыта), выходим
    
    fetch("{% url 'cart:cart_summary' %}")
        .then(res => res.text())
        .then(html => {
            summaryEl.outerHTML = html;
        })
        .catch(err => console.error('Error updating cart summary:', err));
}

// обновляем при загрузке страницы
updateCartCount();

// обновляем после каждого HTMX запроса
document.body.addEventListener('htmx:afterRequest', (evt) => {
    const url = evt.detail.xhr.responseURL;
    
    // Обновляем счетчик для всех запросов к корзине
    if (url && url.includes('/cart/')) {
        updateCartCount();
        
        // Обновляем итоги только для операций изменения/удаления
        if (url.includes('update') || url.includes('remove')) {
            setTimeout(() => updateCartSummary(), 100);
        }
    }
});

// Обработка уведомлений (для кнопки "Добавить в корзину")
document.body.addEventListener('htmx:afterSwap', (evt) => {
    // Если контент обновился в #main-content, скроллим наверх
    if (evt.detail.target.id === 'main-content') {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
});

// закрытие по клику вне корзины
document.addEventListener("click", (e) => {
    const modal = document.getElementById("main-cart-modal");
    const cartBtn = document.getElementById("cart-button");

    if (!modal.contains(e.target) && !cartBtn.contains(e.target)) {
        modal.classList.add("hidden");
    }
});
</script>

</body>
</html>