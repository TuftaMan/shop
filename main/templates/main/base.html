{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Мой Магазин{% endblock %}</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="bg-white">

<header class="sticky top-0 bg-white shadow z-50">
    <div class="container mx-auto flex justify-between items-center p-4">
        <!-- ЛЕВАЯ ЧАСТЬ — ВЫПАДАЮЩЕЕ МЕНЮ + ЛОГОТИП -->
        <div class="flex items-center space-x-3">
            <!-- Кнопка меню -->
            <div class="relative">
                <button id="menu-button" class="flex items-center">
                    <img src="{% static 'main/three-line-horizontal.svg' %}" alt="Меню" class="h-10 cursor-pointer">
                </button>
                
                <!-- Выпадающее меню -->
                <div id="dropdown-menu" class="hidden absolute left-0 mt-2 w-40 bg-white shadow-lg border rounded-lg overflow-hidden z-50">
                    <button hx-get="{% url 'main:catalog_all' %}" 
                            hx-target="#main-content" 
                            hx-push-url="true" 
                            class="w-full text-left px-4 py-2 hover:bg-gray-100">
                        Магазин
                    </button>
                    <button hx-get="{% url 'main:about' %}" 
                            hx-target="#main-content" 
                            hx-push-url="true" 
                            class="w-full text-left px-4 py-2 hover:bg-gray-100">
                        О нас
                    </button>
                </div>
            </div>
            <!-- ЛОГОТИП (переход на главную) -->
            <a href="{% url 'main:index' %}"
                class="flex items-center">
                <img src="{% static 'main/DRIFT.png' %}" 
                    alt="DriftWood" 
                    class="h-7 cursor-pointer hover:opacity-80 transition">
            </a>
        </div>

        <!-- ПРАВАЯ ЧАСТЬ — ИКОНКА КОРЗИНЫ -->
        <div>
            <button id="cart-button" 
                    hx-get="{% url 'cart:cart_modal' %}" 
                    hx-target="#main-cart-modal" 
                    hx-swap="innerHTML"
                    class="relative">
                <img src="{% static 'main/7784863.png' %}" alt="Корзина" class="h-8">
                <span id="cart-count" class="absolute top-0 right-0 bg-red-500 text-white rounded-full text-xs w-5 h-5 flex items-center justify-center">
                    0
                </span>
            </button>
        </div>
    </div>
</header>


<!-- ОСНОВНОЙ КОНТЕЙНЕР HTMX -->
<main id="main-content">
    {% block main_content %}
    <!-- Главная большая картинка -->
    <a
        hx-get="{% url 'main:catalog_all' %}"
        hx-target="#main-content"
        hx-push-url="true"
    >
        <img src="{% static 'main/1.png' %}" alt="Главная" class="w-full h-screen object-cover cursor-pointer">
    </a>
    {% endblock %}
</main>



<footer class="bg-gray-100 py-8 mt-8">
    <div class="container mx-auto text-center text-white-700">
        <p>© 2025 Мой Магазин. Все права защищены.</p>
    </div>
</footer>


<!-- Модальное окно корзины -->
<div id="main-cart-modal" 
     class="fixed top-16 right-0 bg-white w-96 max-h-[80vh] overflow-y-auto
            shadow-2xl border border-gray-200 rounded-xl hidden z-50 transition-all duration-300">
</div>

<!-- Контейнер для уведомлений -->
<div id="notification-container" class="fixed top-20 right-4 z-50 space-y-2"></div>


<script>
// ========== ВЫПАДАЮЩЕЕ МЕНЮ ==========
const menuButton = document.getElementById("menu-button");
const dropdownMenu = document.getElementById("dropdown-menu");

// Открытие/закрытие меню
menuButton.addEventListener("click", (e) => {
    e.stopPropagation();
    dropdownMenu.classList.toggle("hidden");
});

// Закрытие меню по клику вне его
document.addEventListener("click", (e) => {
    if (!menuButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.classList.add("hidden");
    }
});

// Закрытие меню после клика на пункт меню
const menuItems = dropdownMenu.querySelectorAll("button, a");
menuItems.forEach(item => {
    item.addEventListener("click", () => {
        dropdownMenu.classList.add("hidden");
    });
});


// ========== КОРЗИНА ==========
document.getElementById('cart-button').addEventListener('click', function() {
    const modal = document.getElementById('main-cart-modal');
    modal.classList.toggle('hidden');
});

function updateCartCount() {
    fetch("{% url 'cart:cart_count' %}")
        .then(res => res.json())
        .then(data => {
            document.getElementById('cart-count').textContent = data.total_items;
        });
}

// обновляем при загрузке страницы
updateCartCount();

// обновляем после каждого HTMX запроса
document.body.addEventListener('htmx:afterRequest', (evt) => {
    if(evt.detail.xhr.responseURL.includes('/cart/')) {
        updateCartCount();
    }
});

// закрытие по клику вне корзины
document.addEventListener("click", (e) => {
    const modal = document.getElementById("main-cart-modal");
    const cartBtn = document.getElementById("cart-button");

    if (!modal.contains(e.target) && !cartBtn.contains(e.target)) {
        modal.classList.add("hidden");
    }
});


// ========== УВЕДОМЛЕНИЯ ==========
function showNotification(message, type = 'success') {
    const container = document.getElementById('notification-container');
    const notification = document.createElement('div');
    
    const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    
    notification.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300 flex items-center gap-3`;
    notification.innerHTML = `
        <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
        <span>${message}</span>
    `;
    
    container.appendChild(notification);
    
    // Показываем
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Скрываем через 3 секунды
    setTimeout(() => {
        notification.style.transform = 'translateX(150%)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Показываем уведомление после добавления в корзину
document.body.addEventListener('htmx:afterRequest', (evt) => {
    if(evt.detail.xhr.responseURL.includes('/cart/add/')) {
        if(evt.detail.successful) {
            showNotification('Товар добавлен в корзину');
        }
    }
});
</script>

</body>
</html>