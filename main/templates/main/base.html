{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{% block title %}DriftWood | Авторские изделия ручной работы{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}
    DriftWood — интернет-магазин авторских изделий из дерева ручной работы.
    {% endblock %}">

    <meta property="og:title" content="DriftWood — авторские изделия ручной работы">
    <meta property="og:description" content="Интернет-магазин DriftWood. Авторские изделия из дерева ручной работы.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://driftwoodbrand.ru">
    <link rel="icon" type="image/png" href="{% static 'main/favicon1.png' %}">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106159473', 'ym');

        ym(106159473, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/106159473" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->

</head>
<body class="bg-white min-h-screen flex flex-col overflow-x-hidden">

<header class="sticky top-0 bg-white shadow z-50">
    <div class="container mx-auto flex justify-between items-center p-4">
        <!-- ЛЕВАЯ ЧАСТЬ — ВЫПАДАЮЩЕЕ МЕНЮ + ЛОГОТИП -->
        <div class="flex items-center space-x-3">
            <!-- Кнопка меню -->
            <div class="relative">
                <button id="menu-button" class="flex items-center touch-manipulation p-1">
                    <img src="{% static 'main/burger.svg' %}" alt="Меню" class="h-10 w-10 cursor-pointer">
                </button>
                
                <!-- Выпадающее меню -->
                <div id="dropdown-menu" class="hidden absolute left-0 mt-2 w-48 bg-white shadow-lg border rounded-lg overflow-hidden z-50">
                    <button hx-get="{% url 'main:catalog_all' %}" 
                            hx-target="#main-content" 
                            hx-push-url="true" 
                            class="w-full text-left px-4 py-3 hover:bg-gray-100 touch-manipulation">
                        Магазин
                    </button>
                    <button hx-get="{% url 'main:about' %}" 
                            hx-target="#main-content" 
                            hx-push-url="true" 
                            class="w-full text-left px-4 py-3 hover:bg-gray-100 touch-manipulation">
                        О нас
                    </button>
                    <button href="{% url 'orders:order_track' %}"
                            hx-get="{% url 'orders:order_track' %}" 
                            hx-target="#main-content" 
                            hx-push-url="true" 
                            class="w-full text-left px-4 py-3 hover:bg-gray-100 touch-manipulation">
                        Статус заказа
                    </button>
                </div>
            </div>
            <!-- ЛОГОТИП (переход на главную) -->
            <a href="{% url 'main:index' %}"
                class="flex items-center touch-manipulation">
                <img src="{% static 'main/logo.png' %}" 
                    alt="DriftWood" 
                    class="h-7 cursor-pointer hover:opacity-80 transition">
            </a>
        </div>

        <!-- ПРАВАЯ ЧАСТЬ — ИКОНКА КОРЗИНЫ -->
        <div class="flex items-center gap-4">
            <!-- КОРЗИНА -->
            <button id="cart-button"
            type="button"
            class="relative flex items-center touch-manipulation p-1">
                <img src="{% static 'main/cart.png' %}"
                    alt="Корзина"
                    class="h-9 w-9">
                <span id="cart-count"
                    class="absolute -top-1 -right-1 bg-red-500 text-white
                            rounded-full text-xs w-5 h-5 flex items-center justify-center">
                    0
                </span>
            </button>
            <!-- АККАУНТ -->
            <a href="{% url 'users:profile' %}"
            hx-get="{% url 'users:profile' %}"
            hx-target="#main-content"
            hx-push-url="true"
            class="flex items-center touch-manipulation p-1">
                <img src="{% static 'main/account.png' %}"
                    alt="Аккаунт"
                    class="h-9 w-9 cursor-pointer hover:opacity-80 transition">
            </a>

        </div>
    </div>
</header>


<!-- ОСНОВНОЙ КОНТЕЙНЕР HTMX -->
<main id="main-content" class="flex-grow min-h-[103vh]">
    {% block main_content %}
    <!-- Главная большая картинка -->
    <a
        hx-get="{% url 'main:catalog_all' %}"
        hx-target="#main-content"
        hx-push-url="true"
    >
    <picture>
            <!-- Картинка для мобильных устройств -->
            <source 
                media="(max-width: 640px)" 
                srcset="{% static 'main/mobile.png' %}">
            
            <!-- Картинка для десктопа (по умолчанию) -->
            <img src="{% static 'main/main.png' %}" 
                 alt="Главная" 
                 class="w-full h-screen object-cover cursor-pointer">
        </picture>
    </a>
    {% endblock %}
</main>


<!-- Модальное окно корзины -->
<div id="main-cart-modal" 
     class="fixed top-16 right-0 bg-white 
            w-full sm:w-96 max-w-full sm:max-w-sm
            max-h-[80vh] overflow-y-auto
            shadow-2xl border border-gray-200 rounded-xl 
            hidden z-50 transition-all duration-300">
</div>


<!-- КОНТЕЙНЕР ДЛЯ УВЕДОМЛЕНИЙ -->
<div id="notification-container" class="fixed bottom-4 right-4 z-[9999] flex flex-col gap-2 max-w-[90vw] sm:max-w-md"></div>


<footer class="bg-gray-100 py-8 pb-safe">
    <div class="container mx-auto text-center text-white-700 px-4">
        <p>© 2026 DriftWood</p>
    </div>
</footer>


<script>
// ========== ВЫПАДАЮЩЕЕ МЕНЮ ==========
const menuButton = document.getElementById("menu-button");
const dropdownMenu = document.getElementById("dropdown-menu");

// Открытие/закрытие меню
menuButton.addEventListener("click", (e) => {
    e.stopPropagation();
    e.preventDefault();
    dropdownMenu.classList.toggle("hidden");
});

// Закрытие меню по клику вне его
document.addEventListener("click", (e) => {
    if (!menuButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
        dropdownMenu.classList.add("hidden");
    }
});

// Закрытие меню после клика на пункт меню
const menuItems = dropdownMenu.querySelectorAll("button, a");
menuItems.forEach(item => {
    item.addEventListener("click", () => {
        dropdownMenu.classList.add("hidden");
    });
});


document.body.addEventListener('htmx:afterSwap', function (evt) {
    if (evt.detail.target.id === 'main-cart-modal') {
        const modal = document.getElementById('main-cart-modal');
        modal.classList.remove('hidden');
    }
});

function updateCartCount() {
    fetch("{% url 'cart:cart_count' %}")
        .then(res => res.json())
        .then(data => {
            document.getElementById('cart-count').textContent = data.total_items;
        })
        .catch(err => console.error('Error updating cart count:', err));
}

function updateCartSummary() {
    // Обновляем блок итогов после изменений в корзине
    const summaryEl = document.getElementById('cart-summary');
    if (!summaryEl) return; // Если элемента нет (корзина закрыта), выходим
    
    fetch("{% url 'cart:cart_summary' %}")
        .then(res => res.text())
        .then(html => {
            summaryEl.outerHTML = html;
        })
        .catch(err => console.error('Error updating cart summary:', err));
}

// обновляем при загрузке страницы
updateCartCount();

// обновляем после каждого HTMX запроса
document.body.addEventListener('htmx:afterRequest', (evt) => {
    const url = evt.detail.xhr.responseURL;
    
    // Обновляем счетчик для всех запросов к корзине
    if (url && url.includes('/cart/')) {
        updateCartCount();
        
        // Обновляем итоги только для операций изменения/удаления
        if (url.includes('update') || url.includes('remove')) {
            setTimeout(() => updateCartSummary(), 100);
        }
    }
});

// Обработка уведомлений (для кнопки "Добавить в корзину")
document.body.addEventListener('htmx:afterSwap', (evt) => {
    // Если контент обновился в #main-content, скроллим наверх
    if (evt.detail.target.id === 'main-content') {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
});

// закрытие корзины по клику вне её
document.addEventListener("click", (e) => {
    const modal = document.getElementById("main-cart-modal");
    const cartBtn = document.getElementById("cart-button");

    if (!modal.contains(e.target) && !cartBtn.contains(e.target)) {
        modal.classList.add("hidden");
    }
});

// открытие/закрытие корзины
const cartButton = document.getElementById('cart-button');
const cartModal = document.getElementById('main-cart-modal');

cartButton.addEventListener('click', function (e) {
    e.stopPropagation();

    // если корзина уже открыта — закрываем
    if (!cartModal.classList.contains('hidden')) {
        cartModal.classList.add('hidden');
        return;
    }

    // если корзина закрыта — загружаем и открываем
    htmx.ajax('GET', "{% url 'cart:cart_modal' %}", {
        target: '#main-cart-modal',
        swap: 'innerHTML'
    });
});

// Предотвращение двойного тапа (zoom) на iOS для кнопок
let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
        event.preventDefault();
    }
    lastTouchEnd = now;
}, false);

</script>

</body>
</html>